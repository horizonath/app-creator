generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ContentType {
  COMIC
  NOVEL
}

enum UnlockType {
  FREE
  CREDIT
  MEMBERSHIP_ONLY
}

enum MembershipPlan {
  FREE
  PREMIUM
}

enum ScoreRole {
  READER
  CREATOR
}

enum WalletTxType {
  FAUCET_CLAIM
  UNLOCK_EPISODE
  TIP
  BUY_CREDIT
  XP_TO_CREDIT
  CREDIT_TO_XP
  STAKE_XP
  UNSTAKE_XP
  ADMIN_ADJUST
}


model User {
  id       String  @id @default(cuid())
  email    String  @unique
  username String? @unique
  image    String? // avatar url (NextAuth biasanya pakai "image")
  bio      String?

  // social links
  xUrl         String?
  instagramUrl String?
  tiktokUrl    String?
  youtubeUrl   String?
  websiteUrl   String?

  // roles
  isCreator Boolean @default(false)

  // economy & progression
  xp                    Int            @default(0)
  creditsBalance        Int            @default(0)
  membershipPlan        MembershipPlan @default(FREE)
  membershipActiveUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  series       Series[]
  comments     Comment[]
  likes        Like[]
  favorites    Favorite[]
  ratings      Rating[]
  unlocks      Unlock[]
  episodeReads EpisodeRead[]
  episodeViews EpisodeView[]
  creatorStats CreatorStat?
  readerStats  ReaderStat?

  tipsSent     Tip[] @relation("tipsSent")
  tipsReceived Tip[] @relation("tipsReceived")

  // (jika kamu punya DailyUserScore / Tip / dsb) biarkan tetap, tapi pastikan relasi kebaliknya ada.
  DailyUserScore DailyUserScore[]
  Account        Account[]
  Session        Session[]
  WalletTx       WalletTx[]
}

model Series {
  id        String @id @default(cuid())
  creatorId String
  creator User? @relation(fields: [creatorId], references: [id], onDelete: SetNull)

  type          ContentType
  title         String
  description   String?
  coverImageUrl String?

  // discoverability
  isPublished Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  episodes Episode[]

  // genre (many-to-many)
  genres SeriesGenre[]

  // engagement
  favorites Favorite[]
  ratings   Rating[]

  // aggregation (optional quick fields)
  totalViews    Int   @default(0)
  totalLikes    Int   @default(0)
  totalComments Int   @default(0)
  avgRating     Float @default(0)

  // if you have tips linked to series:
  tips Tip[] // penting untuk opposite relation Tip.series (kalau Tip punya seriesId)
}

model Episode {
  id       String @id @default(cuid())
  seriesId String
  series   Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  title      String
  number     Int
  isLocked   Boolean @default(false)
  unlockCost Int     @default(1)

  // content
  // COMIC: pages; NOVEL: novelBody
  novelBody String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pages    EpisodePage[]
  comments Comment[]
  likes    Like[]
  unlocks  Unlock[]
  reads    EpisodeRead[]
  views    EpisodeView[]
  Tip      Tip[]

  @@unique([seriesId, number])
}

model EpisodePage {
  id        String  @id @default(cuid())
  episodeId String
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  pageNumber Int
  imageUrl   String

  @@unique([episodeId, pageNumber])
}

model EpisodeView {
  id        String  @id @default(cuid())
  episodeId String
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  // logged-in viewer
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // guest viewer
  anonId String? // cookie anon id

  // Day bucket (set to 00:00 UTC)
  day DateTime?

  createdAt DateTime @default(now())

  // Unique view per day:
  // - user: unique(userId, episodeId, day)
  // - guest: unique(anonId, episodeId, day)
  @@unique([episodeId, day, userId])
  @@unique([episodeId, day, anonId])
  @@index([episodeId, day])
}

model Like {
  id        String   @id @default(cuid())
  episodeId String
  userId    String
  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([episodeId, userId])
  @@index([episodeId])
}

model Comment {
  id        String   @id @default(cuid())
  episodeId String
  userId    String
  content   String
  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([episodeId])
}

model Unlock {
  id        String   @id @default(cuid())
  episodeId String
  userId    String
  cost      Int      @default(1)
  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([episodeId, userId])
  @@index([userId, createdAt])
}

model EpisodeRead {
  id        String   @id @default(cuid())
  episodeId String
  userId    String
  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([episodeId, userId]) // anti-farm
  @@index([userId, createdAt])
}

model Tip {
  id         String  @id @default(cuid())
  fromUserId String
  toUserId   String
  episodeId  String?
  seriesId   String?
  amount     Int
  refType    String?
  refId      String?
  meta       Json?

  createdAt DateTime @default(now())

  fromUser User     @relation("tipsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User     @relation("tipsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  episode  Episode? @relation(fields: [episodeId], references: [id], onDelete: SetNull)
  series   Series?  @relation(fields: [seriesId], references: [id], onDelete: SetNull)

  @@index([toUserId, createdAt])
  @@index([fromUserId, createdAt])
}

model DailyUserScore {
  id     String    @id @default(cuid())
  date   DateTime
  userId String
  role   ScoreRole
  score  Int       @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, userId, role])
  @@index([role, date])
}

// ---- Auth.js models (NextAuth / Auth.js) ----

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Genre {
  id   String @id @default(cuid())
  slug String @unique
  name String

  series SeriesGenre[]
}

model SeriesGenre {
  seriesId String
  genreId  String

  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  genre  Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([seriesId, genreId])
}

model Favorite {
  userId    String
  seriesId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@id([userId, seriesId])
}

model Rating {
  userId    String
  seriesId  String
  value     Int // 1..5
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@id([userId, seriesId])
}

model CreatorStat {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalViews    Int      @default(0)
  totalLikes    Int      @default(0)
  totalComments Int      @default(0)
  updatedAt     DateTime @updatedAt
}

model ReaderStat {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalReads Int      @default(0)
  updatedAt  DateTime @updatedAt
}

model WalletTx {
  id     String       @id @default(cuid())
  userId String
  type   WalletTxType

  // perubahan saldo
  xpDelta     Int @default(0)
  creditDelta Int @default(0)

  // referensi transaksi ke objek tertentu
  refType String?
  refId   String?

  // meta tambahan (rates, fee, ip hash, dll)
  meta Json?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
}
